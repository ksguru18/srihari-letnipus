ISecL v1 Server containers
==========================
This repo is to create an image for ISL v1 Verification Service container. 
Below instructions help in building and running the Verification Service 
contianer on Docker runtime.

Pre-requisites
----------------------

* Install Docker runtime: yum install -y docker
* Start docker service: systemctl start docker
* Install docker-compose: 
    sudo curl -L https://github.com/docker/compose/releases/download/1.21.2/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose
    sudo chmod +x /usr/local/bin/docker-compose

    More info: https://docs.docker.com/compose/install/#install-compose

Building the containers
-----------------------

ISecL sever components could be built using docker-compose or vanilla docker commands. 
This section explains building the images using docker-compose

* **Directory structure**
    ISL v1 Verification Service ontainer can be built using docker-compose. 
    For building the containers, below files and directories are expected 
    in the build(current) directory where the docker-compse.yml is exists.

    .
    +-- docker\_compose.yml 
    |
    +-- mtwilson.env
    |
    +-- db.password: postgres DB password (default: Ch@ng3_m3. Change it before running the container)
    |
    +-- Dockerfile: Invoked by docker-compose to buid the image
    |
    +-- host-verification-service-linux-4.0*.bin: Installer
    |
    +-- start_hvs: Entrypscript
    |
    +-- yum.repos.d/: To leverage custom RHEL repos


* **Container Environment**
    ISecL v1 Containers are built over RHEL 7.4 base image. When creating the container
    image, the installers are run such that the static content is extracted  
    and placed in the right locations (ex: /opt/verification-service).

    All setup and provisioning tasks are performed during the image launch

* **Docker build command**

    *Simple Container image build*
    docker-compose build -t verification-service

    *Container build behind proxy with custom RHEL repos*

    docker-compose build --build-arg http_proxy=<http_proxy_server> \
        --build-arg https_proxy=<https_proxy_server> \
        --build-arg no_proxy=<repo_and_other_local_servers> \
        verification-service

Running the container
---------------------

* **Create volumes**
    All the configuration, logs and non-static content generated by the agent
    is stored as part of the volumes so that the agent container remains 
    stateless. So, the below volumes needs to be created before launching the
    agent container.

    Refer [Docker Volumes](https://docs.docker.com/storage/volumes/) for volume 
    management on Docker


    * **Verification Service volumes** *

    | Type          | Name                      | Container Path                     |
    |:-------------:|:-------------------------:|:----------------------------------:|
    | Volume        | ahub_config-volume        | /opt/verification-service/configuration |
    | Volume        | ahub-logs-volume          | /opt/verification-service/logs          |
    | Volume        | ahub-tenant-config-volume | /opt/tenantconfig                  |

    Volumes would be automatically created by docker-compose. 

    Below are the commands to create the required "Volumes" if native docker 
    commands are used to run the image

    > # Create volume for tagent_logs
    > docker volume create --label ahub-config-volume


* **Running ISecLv1 Verification Service image**

    Running the ISecL v1 Verification Service container, below env file is needed 
    with the verification server details

    * mtwilson.env
        Contains the Admin Username and password. If provided this user is created on verification-service

        MC_FIRST_USERNAME=<Admin user>
        MC_FIRST_PASSWORD=<Admin password>

    * db.password

         Update the file to set the Postgres password

    * **Command to run ISecL v1 agent** *
    docker-compose up --remove-orphans --abort-on-container-exit

    `docker ps` should show the Verification Service and postgres containers as below
        verification-service_verification-service_1
        verification-service_hvs-pg-db_1

* **Restarting the Container**

    Once the container is down/stopped (docker-compose down), the containers does not need the env files and
    db.password to restart since the setup activities are done during the first launch and the configurations
    are stoed as part of the volumes. 

    Two options to run the containers without the configuration

        1. Comment out all the "secrets" block in docker-compose.yml

        2. Delete all the contents in the env and db.password files.

    After the above, run docker-compose up --remove-orphans to start the containers again
